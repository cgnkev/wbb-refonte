{% extends "::base.html.twig" %}
{% block meta %}<meta name="description" content="{{ bar.seoDescription }}" />{% endblock %}
{% block title %}{{ bar.name }} | World Best Bars{% endblock %}

{% block javascripts %}
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
        /**
         * TODO : Créer des fonctions JS pour gérer cette partie
         */
        var barId = "{{ bar.id }}",
                venue  = "{{ bar.foursquare }}",
                insta = "{{ bar.instagram }}",
                imgs = [],
                i, m, n, reste, lastImages,
                fsq = [],
                ins = [],
                html = "";
        $(document).ready(function(){
            $('#showOpenings').click(function(){
                var link = $(this);
                $('.openings').toggle();
                if ($('.openings').is(':visible')) {
                    link.text('(Show less)');
                } else {
                    link.text('(See all)');
                }
            });
            $.ajax({
                type: "POST",
                url:  Routing.generate('wbb_bar_feeds_list',
                        { type: "fsimgs", bar: barId }),
                dataType: 'json',
                success: function(r) {
                    $.ajax({
                        type: "POST",
                        url:  Routing.generate('wbb_bar_feeds_find',
                                { type: "fsimgs", id: venue }),
                        dataType: 'json',
                        success: function(response) {
                            i = 0;
                            if (typeof response.data != 'undefined') {
                                $.each(response.data, function(key, feed){
                                    if(in_array(feed.id, r) && i<5) {
                                        fsq.push('<div class="image"><div class="content"><div class="overlay"></div><a class="btn-round foursquare dark"></a><img src="'+feed.prefix+"640x480"+feed.suffix+'"/></div></div>');
                                        i++;
                                    }
                                });
                            }
                            $.ajax({
                                type: "POST",
                                url:  Routing.generate('wbb_bar_feeds_list',
                                        { type: "instagram", bar: barId}),
                                dataType: 'json',
                                success: function(r) {
                                    $.ajax({
                                        type: "POST",
                                        url:  Routing.generate('wbb_bar_feeds_find',
                                                { type: "instagram", id: insta}),
                                        dataType: 'json',
                                        success: function(response) {
                                            i = 0;
                                            if (typeof response.data != 'undefined') {
                                                $.each(response.data.data, function(key, feed){
                                                    if(!in_array(feed.id, r) && i<5) {
                                                        ins.push('<div class="image"><div class="content"><div class="overlay"></div><a class="btn-round instagram dark"></a><img src="'+feed.images.standard_resolution.url+'"/></div></div>');
                                                        i++;
                                                    }
                                                });
                                            }
                                            for(i=0; i<=4; i+=2){
                                                if(typeof ins[i] != 'undefined') { html+=ins[i]; }
                                                if(typeof ins[i+1] != 'undefined') { html+=ins[i+1]; }
                                                if(typeof fsq[i] != 'undefined') { html+=fsq[i]; }
                                                if(typeof fsq[i+1] != 'undefined') { html+=fsq[i+1]; }
                                            }
                                            $('.ui-slide').append(html);
                                            imgs = $('.ui-slide .image');
                                            $('.ui-slide').remove();
                                            html = "";
                                            for(n=0; n<Math.ceil(imgs.length/4); n++){
                                                html+='<div class="ui-slide">';
                                                for(m=n*4; m<(n+1)*4; m++){
                                                    if(imgs[m]){
                                                        html+=nodeToString(imgs[m]);
                                                    }
                                                }
                                                html+='</div>';
                                            }
                                            $(".loader").css('display','none');
                                            $('.ui-slider').append(html);
                                            reste  = 4-$('.ui-slide .image').length%4;
                                            lastImages = $('.ui-slide .image').slice(reste);
                                            i=1;
                                            $.each(lastImages, function(key, element){
                                                if(i<=reste){
                                                    $('.ui-slide:last-child').append('<div class="image">'+element.innerHTML+'</div>');
                                                }
                                                i++;
                                            });
                                            initializeSliders();
                                        },
                                        error: function(e) {
                                            console.log(e);
                                        }
                                    });
                                },
                                error: function(e) {
                                    console.log(e);
                                }
                            });

                        },
                        error: function(e) {
                            console.log(e);
                        }
                    });
                },
                error: function(e) {
                    console.log(e);
                }
            });
        });
        function initialise() {
            var myLatlng = new google.maps.LatLng({{ bar.latitude }},{{ bar.longitude }}); // Add the coordinates
            var mapOptions = {
                zoom: 14, // The initial zoom level when your map loads (0-20)
                minZoom: 6, // Minimum zoom level allowed (0-20)
                maxZoom: 17, // Maximum soom level allowed (0-20)
                zoomControl:true, // Set to true if using zoomControlOptions below, or false to remove all zoom controls.
                zoomControlOptions: {
                    style:google.maps.ZoomControlStyle.SMALL // Change to SMALL to force just the + and - buttons.
                },
                center: myLatlng, // Centre the Map to our coordinates variable
                mapTypeId: google.maps.MapTypeId.ROADMAP, // Set the type of Map
                scrollwheel: false, // Disable Mouse Scroll zooming (Essential for responsive sites!)
                // All of the below are set to true by default, so simply remove if set to true:
                panControl:false, // Set to false to disable
                mapTypeControl:false, // Disable Map/Satellite switch
                scaleControl:false, // Set to false to hide scale
                streetViewControl:false, // Set to disable to hide street view
                overviewMapControl:false, // Set to false to remove overview control
                rotateControl:false // Set to false to disable rotate control
            }
            var map = new google.maps.Map(document.getElementById('gmap'), mapOptions); // Render our map within the empty div

            var image = new google.maps.MarkerImage("http://wbb.lapreprod.com/bundles/wbbcore/images/icons/pin2.gmap.png", null, null, null, new google.maps.Size(34,47)); // Create a variable for our marker image.

            var marker = new google.maps.Marker({ // Set the marker
                position: myLatlng, // Position marker to coordinates
                icon:image, //use our image as the marker
                map: map, // assign the market to our map variable
                title: '{{ bar.name }}' // Marker ALT Text
            });

            // 	google.maps.event.addListener(marker, 'click', function() { // Add a Click Listener to our marker
            //		window.location='http://www.snowdonrailway.co.uk/shop_and_cafe.php'; // URL to Link Marker to (i.e Google Places Listing)
            // 	});

            var infowindow = new google.maps.InfoWindow({ // Create a new InfoWindow
                content:"{{ bar.name }}" // HTML contents of the InfoWindow
            });

            google.maps.event.addListener(marker, 'click', function() { // Add a Click Listener to our marker
                infowindow.open(map,marker); // Open our InfoWindow
            });

            google.maps.event.addDomListener(window, 'resize', function() { map.setCenter(myLatlng); }); // Keeps the Pin Central when resizing the browser on responsive sites
             $('#gmap').append('<div class="get-directions h4"><a href="https://www.google.fr/maps/dir//{{ bar.latitude }},{{ bar.longitude }}" class="btn-small-radius border brown" target="_blank">Get Directions</a></div>')
        }
        google.maps.event.addDomListener(window, 'load', initialise); // Execute our 'initialise' function once the page has loaded.
       

    </script>
{% endblock %}
{% block bodyTag %}
<body class="bar-details">
{% endblock %}
{% block body %}
    <!-- SUBHEADER -->
<div class="container">
    <section class="sub-header">
        <table>
            <tr>
                {% if not is_mobile() or is_tablet() %}
                <td>
                    <div class="city-selector h3">
                        You are in
                        <a class="btn-radius with-icon border brown place" href="">{{ bar.city.name|default('Unspecified') }}</a>
                    </div>                        </td>
                {% endif %}
                <td class="title">
                    <h1>{{ bar.name }}</h1>
                    <h3>{{ bar.suburb.name|default('Unspecified') }}, {{ bar.city.name|default('Unspecified') }}</h3>
                </td>

                <td class="star-share">
                    <a class="btn-round brown star" href=""></a><a class="btn-round brown share" href=""></a>
                </td>
            </tr>
        </table>
    </section>
</div>
    <!-- SLIDER -->
    <div class="container full">
    <section class="gallery">
        <div class="main">
            {% for m in bar.medias|slice(0,1) %}
                {% if m.media.providerName == 'sonata.media.provider.youtube' %}
                    <div class="video has_sizer" data-size="4x3">
                        <iframe width="853" height="480" src="http://www.youtube.com/embed/{{ m.media.providerReference }}?autoplay=0&modestbranding=1&rel=0&showinfo=0&autohide=1&color=white&theme=light&wmode=transparent" frameborder="0" allowfullscreen></iframe>
                    </div>
                {% else %}
                    <div class="image">
                        <div class="content">
                            <div class="overlay"></div>
                            <img src="{% path m.media, 'slider_large' %}" />
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="ui-slider type-bar-detail has_sizer arrows infinite" data-size="4x3" data-animation="latency">
            <img class="loader" src="{{ asset('bundles/wbbbar/img/loader.gif') }}" alt="" />
            <div class="ui-slide" style="display:none">
                {% for m in bar.medias %}

                    {% if not loop.first %}
                    <div class="image">
                        <div class="content">
                            <div class="overlay"></div>
                            <img src="{% path m.media, 'slider_small' %}"/>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </section>
    </div>
<div class="container">
<section class="content">
        <!-- MAIN CONTENT -->
        <article class="main">
            {% if not is_mobile() or is_tablet() %}<div class="twelve columns h1 l-margin-top mobile-out">About the bar</div>{% endif %}
            <div class="eight columns l-margin-top">

                <ul class="trends">
                    <li>At a Glance :</li>
                    {% for tr in bar.tags %}
                        <li>{{ tr.tag }}</li>
                    {% endfor%}
                </ul>

                    <p>{{ bar.description|raw|nl2br }}</p>
                <!-- ALSO APPEARS -->
                {% if not is_mobile() or is_tablet() %}
                <div class="also-appears">
                    <hr class="l-margin"/>
                    <div class="m-margin-top h2">This bar appears also in</div>
                    <div class="m-margin-top h3">
                        <ul>
                            <li>
                                <a href="">
                                    Interview with Nick Miller
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    Best Cocktails Bars in New York
                                </a>
                            </li>
                            <li>
                                <a href="">
                                    The Bar Project from Ballantine’s
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
            <!-- ASIDE -->
            <aside class="columns four">
                <div class="block informations">
                    <div class="contain">
                        <div class="gmap" id="gmap" style="height:124px; width:332px;">
                            
                        </div>
                        <p>
                            {{ bar.address }}<br/>
                            {{ bar.city }}<br/>
                            {% if is_mobile() and not is_tablet() %}
                                <a href='tel:{{ bar.phone }}'>{{ bar.phone }}</a><br/>
                            {% else %}
                                {{ bar.phone }}<br/>
                            {% endif %}
                            <a href="mailto:{{ bar.email }}">{{ bar.email }}</a>
                            <br/>
                            {% if bar.website %}<a href="{{ bar.website }}" class="btn-small-round www brown" target="_blank"></a>{% endif %}
                            {% if bar.twitter %}<a href="http://www.twitter.com/{{ bar.twitter }}" class="btn-small-round twitter" target="_blank"></a>{% endif %}
                            {% if bar.facebook %}<a href="https://www.facebook.com/{{ bar.facebook }}" class="btn-small-round facebook" target="_blank"></a>{% endif %}
                            {% if bar.foursquare %}<a href="https://www.foursquare.com/v/{{ bar.foursquare }}" class="btn-small-round foursquare" target="_blank"></a>{% endif %}
                            {% if bar.instagram %}<a href="https://www.instagram.com/{{ bar.instagram }}" class="btn-small-round instagram" target="_blank"></a>{% endif %}
                        </p>
                        <hr class="s-margin"/>
                        <div class="p">
                            Hours:
                            {% for opening in bar.openings %}
                                {% if opening.openingDay == "now"|date("N") %}
                                    Today 
                                    {% if opening.fromHour|number_format<=12 %}
                                        {{ opening.fromHour }}:00 am
                                    {% else %}
                                        {{ (opening.fromHour|number_format)-12 }}:00 pm
                                    {% endif %}
                                     - 
                                    {% if opening.toHour|number_format<=12 %}
                                        {{ opening.toHour }}:00 am
                                    {% else %}
                                        {{ (opening.toHour|number_format)-12 }}:00 pm
                                    {% endif %}
                                {% endif %}
                            {% endfor%}
                            <a href="#0" id="showOpenings">(See all)</a><br/>
                            <span class="openings" style="display: none">
                            {% set days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"] %}
                                {% for opening in bar.openings %}
                                    &nbsp;&nbsp;&nbsp;&nbsp;{{ days[opening.openingDay-1] }} : 
                                    {% if opening.fromHour|number_format<=12 %}
                                        {{ opening.fromHour }}:00 am
                                    {% else %} 
                                        {{ (opening.fromHour|number_format)-12 }}:00 pm
                                    {% endif %}
                                     - 
                                    {% if opening.toHour|number_format<=12 %}
                                        {{ opening.toHour }}:00 am
                                    {% else %}
                                        {{ (opening.toHour|number_format)-12 }}:00 pm
                                    {% endif %}
                                    <br />
                                {% endfor%}
                            </span>
                            Accepts Credit Cards: {% if bar.isCreditCard %}Yes{% else %}No{% endif %}<br/>
                            Coat Check: {% if bar.isCoatCheck %}Yes{% else %}No{% endif %}<br/>
                            {% if bar.parking %}Parking: {{ bar.parking }}<br/>{% endif %}
                            Price: {% for i in 1..4 %}<span {% if i <= bar.price|number_format %}style="color:#b3955f"{% endif %}>$</span>{% endfor %} {% if bar.menu %}<a href="{{ bar.menu }}" target="_blank">(View menu)</a>{% endif %}<br/>
                            Reservation: {% if bar.isReservation %}Yes{% else %}No{% endif %}<br/>
                            {% if bar.reservation %}<a href="{{ bar.reservation }}" class="btn-small-radius border brown" target="_blank">Make a Reservation</a>{% endif %}
                        </div>
                    </div>
                </div>
                {% if not is_mobile() or is_tablet() %}
                <div class="block">
                    <div class="side-ad m-margin-top">
                        <img src="{{ asset('/bundles/wbbcore/images/tmp/ad.side.jameson.png') }}" alt="ad.jameson" width="300" height="250"/>
                        <div class="txt">Advertising</div>
                    </div>
                </div>
                {% endif %}
            </aside>
        </article>
    </section>
</div>
    <!-- INSIDER TIPS -->
    <section class="insider-tips m-margin-top">

        <div class="container load-container">

            <div class="twelve columns align-center l-margin-top m-margin-bottom h1">
                Insider Tips
            </div>

            <div class="line">

                {% if not is_mobile() or is_tablet() %}
                    <div class="three columns box">
                        <article class="tip">
                            <div class="content form">
                                <form>
                                    <h3>Leave a tip</h3>
                                    <textarea class="s-margin-top" name="" id="" placeholder="Type a tip ..."></textarea>
                                    <div class="m-margin-top h4 count">499 left</div>
                                    <input class="s-margin-top btn-small-radius brown" type="submit" value="Submit"/>
                                </form>
                                <br class="clear"/>
                            </div>
                        </article>
                    </div>
                {% endif %}


                <div class="three columns box">
                    <article class="tip">

                        <table class="content expert">

                            <tr class="excerpt">
                                <td colspan="2">
                                    <div class="scroll">
                                        “NY. This Portuguese/ Chinese fusion restaurant offers an exciting blend of exotic dishes that make dining at Macao a unique experience.”
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                    <hr class="s-margin-bottom"/>
                                </td>
                            </tr>

                            <tr class="author">
                                <td>
                                    <img src="{{ asset('/bundles/wbbcore/images/tmp/user.ryan.png') }}" alt="user" width="40" height="40"/>
                                </td>
                                <td>
                                    <b>Expert</b>
                                    Ryan Melon
                                </td>
                            </tr>


                        </table>
                    </article>
                </div>


                <div class="three columns box">
                    <article class="tip">

                        <table class="content expert">

                            <tr class="excerpt">
                                <td colspan="2">
                                    <div class="scroll">
                                        “NY. This Portuguese/ Chinese fusion restaurant offers an exciting blend of exotic dishes that make dining at Macao a unique experience.”
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                    <hr class="s-margin-bottom"/>
                                </td>
                            </tr>

                            <tr class="author">
                                <td>
                                    <img src="{{ asset('/bundles/wbbcore/images/tmp/user.ryan.png') }}" alt="user" width="40" height="40"/>
                                </td>
                                <td>
                                    <b>Expert</b>
                                    Ryan Melon
                                </td>
                            </tr>


                        </table>
                    </article>
                </div>

                <div class="three columns box">
                    <article class="tip">

                        <table class="content expert">

                            <tr class="excerpt">
                                <td colspan="2">
                                    <div class="scroll">
                                        “NY. This Portuguese/ Chinese fusion restaurant offers an exciting blend of exotic dishes that make dining at Macao a unique experience.”
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <td colspan="2">
                                    <hr class="s-margin-bottom"/>
                                </td>
                            </tr>

                            <tr class="author">
                                <td>
                                    <img src="{{ asset('/bundles/wbbcore/images/tmp/user.ryan.png') }}" alt="user" width="40" height="40"/>
                                </td>
                                <td>
                                    <b>Expert</b>
                                    Ryan Melon
                                </td>
                            </tr>


                        </table>
                    </article>
                </div>

            </div>

            <div class="line load-target"></div>

            {% if is_mobile() and not is_tablet() %}

            <div class="twelve columns align-center m-margin">
                <a class="btn-radius border load-more brown" href="{{ path('wbb_bar_tips',{id:bar.id}) }}">Load More</a>
            </div>

                <div class="three columns box">
                    <article class="tip">
                        <div class="content form">
                            <form>
                                <h3>Leave a tip</h3>
                                <textarea class="s-margin-top" name="" id="" placeholder="Type a tip ..."></textarea>
                                <div class="m-margin-top h4 count">499 left</div>
                                <input class="s-margin-top btn-small-radius brown" type="submit" value="Submit"/>
                            </form>
                            <br class="clear"/>
                        </div>
                    </article> 
                </div>

            {% else %}

            <div class="twelve columns align-center m-margin">
                <a class="btn-radius border load-more brown" href="{{ path('wbb_bar_tips',{id:bar.id}) }}">Load More</a>
            </div>

            {% endif %}
        </div>

    </section>
    <!-- ALSO APPEARS -->
    {% if is_mobile() and not is_tablet() %}
    <div class="container">
        <div class="twelve columns">
            <div class="also-appears">
                <div class="m-margin-top h2">This bar appears also in</div>
                <div class="m-margin-top h3">
                    <ul>
                        <li>
                            <a href="">
                                Interview with Nick Miller
                            </a>
                        </li>
                        <li>
                            <a href="">
                                Best Cocktails Bars in New York
                            </a>
                        </li>
                        <li>
                            <a href="">
                                The Bar Project from Ballantine’s
                            </a>
                        </li>
                    </ul>
                </div>
                <hr class="l-margin-top"/>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- ALSO LIKE -->
    <section class="also-like">
        <div class="container m-padding-bottom">
            <div class="h1 twelve columns align-center l-margin-top m-margin-bottom">
                {% if oneCity %}Related bars in {{ bar.city.name|default('Unspecified') }}{% else %}You May Also Like{% endif %}
            </div>
            {% for b in barLike %}
                <div class="three columns">
                    {% if is_mobile() and not is_tablet() %}
                        <article class="bar-wo-pic">
                            <a href="" class="btn-round dark star"></a>
                            <div class="txt">
                                <h2>{{ b.bar.name }}</h2>
                                <h3>{{ b.bar.suburb.name|default('Unspecified') }}, {{ b.bar.city.name|default('Unspecified') }}</h3>
                            </div>
                            <a href="{{ path('wbb_bar_details',{id:b.bar.id}) }}" class="overlay-link"></a>
                        </article>
                    {% else %}
                    <article class="bar-w-pic">
                        <a href="" class="btn-round dark star"></a>
                        <div class="txt">
                            <h2>{{ b.bar.name }}</h2>
                            <h3>{{ b.bar.suburb.name|default('Unspecified') }}, {{ b.bar.city.name|default('Unspecified') }}</h3>
                            <div class="tags">
                                {% for tr in b.bar.tags %}
                                    {{ tr.tag }}{% if not loop.last %}, {% endif %}
                                {% endfor%}
                            </div>
                        </div>
                        <a href="{{ path('wbb_bar_details',{id:b.bar.id}) }}" class="overlay-link"></a>
                        <div class="gradient"></div>
                        {% for m in b.bar.medias|slice(0,1) %}
                            <img class="scale-with-grid" src="{% path m.media, 'slider_large' %}"  alt="{{ b.bar.name }}" width="570" height="428"/>
                        {% endfor %}
                    </article>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </section>
    <!-- AD -->
    {% if not is_mobile() or is_tablet() %}

        <section class="footer-ad">
            <div class="container align-center">
                <div class="twelve columns">
                    <hr/>
                    <img class="m-margin scale-with-grid" src="{{ asset('/bundles/wbbcore/images/tmp/ad.pre-footer.jpg') }}" alt="ad.chivas" width="728" height="90"/>
                </div>
            </div>
        </section>

    {% endif %}
{% endblock %}


